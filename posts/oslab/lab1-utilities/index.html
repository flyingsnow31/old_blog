<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Lab1 Utilities | Flying Snow Blog</title><meta name=keywords content="操作系统,6.S081,Utilities"><meta name=description content="6.S081 Lab1"><meta name=author content="LZY"><link rel=canonical href=https://flyingsnow31.github.io/posts/oslab/lab1-utilities/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://flyingsnow31.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://flyingsnow31.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://flyingsnow31.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://flyingsnow31.github.io/apple-touch-icon.png><link rel=mask-icon href=https://flyingsnow31.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Lab1 Utilities"><meta property="og:description" content="6.S081 Lab1"><meta property="og:type" content="article"><meta property="og:url" content="https://flyingsnow31.github.io/posts/oslab/lab1-utilities/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-26T14:30:58+08:00"><meta property="article:modified_time" content="2022-11-26T14:30:58+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lab1 Utilities"><meta name=twitter:description content="6.S081 Lab1"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://flyingsnow31.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Lab1 Utilities","item":"https://flyingsnow31.github.io/posts/oslab/lab1-utilities/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Lab1 Utilities","name":"Lab1 Utilities","description":"6.S081 Lab1","keywords":["操作系统","6.S081","Utilities"],"articleBody":"Lab1 Utilities 本实验用于熟悉xv6和系统调用\nBoot xv6 (easy) 启动xv6系统\n首先下载mit提供的针对此次实验设计的xv6版本，而非整体的xv6\n$ git clone git://g.csail.mit.edu/xv6-labs-2020 Cloning into 'xv6-labs-2020'... ... $ cd xv6-labs-2020 $ git checkout util Branch 'util' set up to track remote branch 'util' from 'origin'. Switched to a new branch 'util' 在这一步可以将其远程库切换成自己的。\n使用 make qemu 指令编译并通过qemu启动xv6\nmake qemu riscv64-unknown-elf-gcc -c -o kernel/entry.o kernel/entry.S riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel=medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie -c -o kernel/start.o kernel/start.c riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel=medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie -c -o kernel/console.o kernel/console.c ... nmeta 46 (boot, super, log blocks 30 inode blocks 13, bitmap blocks 1) blocks 954 total 1000 balloc: first 591 blocks have been allocated balloc: write bitmap block at sector 45 qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0 xv6 kernel is booting hart 2 starting hart 1 starting init: starting sh $ 输入 ls 命令，可以查看当前目录下的所有信息\n$ ls . 1 1 1024 .. 1 1 1024 README 2 2 2059 xargstest.sh 2 3 93 cat 2 4 23968 echo 2 5 22800 forktest 2 6 13168 grep 2 7 27320 init 2 8 23896 kill 2 9 22768 ln 2 10 22720 ls 2 11 26208 mkdir 2 12 22872 rm 2 13 22856 sh 2 14 41752 stressfs 2 15 23872 usertests 2 16 147512 grind 2 17 37984 wc 2 18 25104 zombie 2 19 22272 console 3 20 0 通过执行 Ctrl + p 可以实现类似 ps 的操作，查看现在执行的所有进程\n$ 1 sleep init 2 sleep sh 要退出qemu，执行 Ctrl - a x\n注意 先按 Ctrl - a 松开后按 x\nsleep (easy) 实现xv6的Unix程序睡眠；您的睡眠应该暂停一个用户指定的节拍数。计时是由xv6内核定义的时间概念，即来自计时器芯片的两个中断之间的时间。您的解决方案应该在文件USER/sleep.c中。\n首先应该阅读 https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf xv6 book的第一章节\n将文件实现放在 user/ 目录下，可以参考其中的 echo.c, grep.c, rm.c 等\n处理命令行参数个数问题\n使用 atoi() 转换字符串到整型\n使用系统调用sleep\n查看 kernel/sysproc.c 中，xv6内核关于sleep系统调用的实现，以及 user/usys.S 关于汇编代码中跳转的部分\n确保main函数执行完成后调用 exit()退出程序\n将sleep加入到Makefile中的UPROGS变量中，以便在 make qemu 时，对其进行编译并能在xv6的shell中调用\n实现如下\n#include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" int main(int argc, char *argv[]) { if(argc \u003c 2) { fprintf(2, \"Usage: sleep time...\\n\"); exit(1); } int n; n = atoi(argv[1]); sleep(n); exit(0); } 在makefile中添加\nUPROGS=\\ $U/_cat\\ $U/_echo\\ $U/_forktest\\ $U/_grep\\ $U/_init\\ $U/_kill\\ $U/_ln\\ $U/_ls\\ $U/_mkdir\\ $U/_rm\\ $U/_sh\\ $U/_stressfs\\ $U/_usertests\\ $U/_grind\\ $U/_wc\\ $U/_zombie\\ $U/_sleep\\ 编译测试\nmake qemu riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel=medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie -c -o user/sleep.o user/sleep.c riscv64-unknown-elf-ld -z max-page-size=4096 -N -e main -Ttext 0 -o user/_sleep user/sleep.o user/ulib.o user/usys.o user/printf.o user/umalloc.o riscv64-unknown-elf-objdump -S user/_sleep \u003e user/sleep.asm riscv64-unknown-elf-objdump -t user/_sleep | sed '1,/SYMBOL TABLE/d; s/ .* / /; /^$/d' \u003e user/sleep.sym mkfs/mkfs fs.img README user/xargstest.sh user/_cat user/_echo user/_forktest user/_grep user/_init user/_kill user/_ln user/_ls user/_mkdir user/_rm user/_sh user/_stressfs user/_usertests user/_grind user/_wc user/_zombie user/_sleep nmeta 46 (boot, super, log blocks 30 inode blocks 13, bitmap blocks 1) blocks 954 total 1000 balloc: first 615 blocks have been allocated balloc: write bitmap block at sector 45 qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0 xv6 kernel is booting hart 1 starting hart 2 starting init: starting sh $ ls . 1 1 1024 .. 1 1 1024 README 2 2 2059 xargstest.sh 2 3 93 cat 2 4 23968 echo 2 5 22800 forktest 2 6 13168 grep 2 7 27320 init 2 8 23896 kill 2 9 22768 ln 2 10 22720 ls 2 11 26208 mkdir 2 12 22872 rm 2 13 22856 sh 2 14 41752 stressfs 2 15 23872 usertests 2 16 147512 grind 2 17 37984 wc 2 18 25104 zombie 2 19 22272 sleep 2 20 22744 console 3 21 0 $ sleep 10 $ 执行成功\n验证 $ ./grade-lab-util sleep make: 'kernel/kernel' is up to date. == Test sleep, no arguments == sleep, no arguments: OK (1.0s) == Test sleep, returns == sleep, returns: OK (1.1s) == Test sleep, makes syscall == sleep, makes syscall: OK (1.0s) pingpong (easy) 实现一个程序，fork一个子进程，在父进程和子进程之间，使用pipe管道进行信息的传递与发送，最后按照格式输出相应的内容和进程号。\n需要查看xv6 book 1.2和1.3章节的相关内容\n具体实现如下。\n#include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" int main(int argc, char *argv[]) { int p1[2], p2[2]; pipe(p1); pipe(p2); if(fork() == 0) { char buf[20]; int fd1 = dup(p1[0]); read(fd1, buf, sizeof(buf)); if(strcmp(\"ping\", buf) == 0) { printf(\"%d:received ping\\n\", getpid()); write(p2[1], \"pong\\0\", 5); } close(p1[0]); close(p1[1]); close(p2[0]); close(p2[1]); exit(0); } else{ write(p1[1], \"ping\\0\", 5); char buf[20]; int fd2 = dup(p2[0]); read(fd2, buf, sizeof(buf)); if(strcmp(\"pong\", buf) == 0) { printf(\"%d:received pong\\n\", getpid()); } close(p1[0]); close(p1[1]); close(p2[0]); close(p2[1]); } exit(0); } 将其加入到makefile后，编译执行\n$ pingpong 4:received ping 3:received pong $ 执行成功\n验证 ./grade-lab-util pingpong make: 'kernel/kernel' is up to date. == Test pingpong == pingpong: OK (0.6s) prime (moderate)/(hard) 实现一个程序，多个进程相连，形成一个流水线，第一个进程向管道中从2输入到35，后续进程依次打印出其中的素数。\n需要熟悉对于管道和文件描述符的操作\n#include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" void prime(int p[2]) { close(p[1]); int p2[2]; pipe(p2); int first[1],second[1]; if(!read(p[0], first, 4)){ return ; } printf(\"prime %d\\n\", first[0]); if(fork() == 0) { prime(p2); } else{ while(read(p[0], second, 4)) { if(second[0] % first[0] == 0) { continue; } write(p2[1], second, 4); } close(p2[1]); } } int main(int argc, char *argv[]) { int p1[2]; pipe(p1); int left[1]; if(fork() == 0) { prime(p1); } else{ for(int i = 2; i \u003c= 35; ++i) { *left = i; write(p1[1], left, 4); } close(p1[1]); } wait(0); exit(0); } 验证 ./grade-lab-util prime make: 'kernel/kernel' is up to date. == Test primes == primes: OK (0.6s) find (moderate) 实现一个查找程序，查找目录下的指定文件\n根据提示，模仿ls.c的程序代码实现，可以发现，可以使用其中的格式化文件命以及遍历目录文件的方式。\n值得注意的是，其中的格式化文件名中，会将较短的文件名扩充至一个dirsiz的大小，如果使用此函数与目标文件名进行比较会出错，需要修改。\n此外，要注意递归的文件，防止递查询 . 和 .. 目录。\n实现代码如下\n#include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" #include \"kernel/fs.h\" char* fmtname(char *path) { static char buf[DIRSIZ+1]; char *p; // Find first character after last slash. for(p=path+strlen(path); p \u003e= path \u0026\u0026 *p != '/'; p--) ; p++; // Return blank-padded name. if(strlen(p) \u003e= DIRSIZ) return p; memmove(buf, p, strlen(p)); buf[strlen(p)] = 0; //memset(buf+strlen(p), ' ', DIRSIZ-strlen(p)); return buf; } void find(char *path, char *target) { char buf[512], *p; int fd; struct dirent de; struct stat st; if((fd = open(path, 0)) \u003c 0){ fprintf(2, \"ls: cannot open %s\\n\", path); return; } if(fstat(fd, \u0026st) \u003c 0){ fprintf(2, \"ls: cannot stat %s\\n\", path); close(fd); return; } //printf(\"%s\\n\", path); switch(st.type){ case T_FILE: if(strcmp(fmtname(path), target) == 0) { printf(\"%s\\n\", path); } break; case T_DIR: if(strlen(path) + 1 + DIRSIZ + 1 \u003e sizeof buf){ printf(\"ls: path too long\\n\"); break; } strcpy(buf, path); p = buf+strlen(buf); *p++ = '/'; while(read(fd, \u0026de, sizeof(de)) == sizeof(de)){ if(de.inum == 0) continue; memmove(p, de.name, DIRSIZ); p[DIRSIZ] = 0; //printf(\"read: %s\\n\", fmtname(buf)); if(stat(buf, \u0026st) \u003c 0){ printf(\"ls: cannot stat %s\\n\", buf); continue; } if(st.type == T_FILE \u0026\u0026 strcmp(fmtname(buf), target) == 0) { printf(\"%s\\n\", buf); } else if(st.type == T_DIR) { //printf(\"t:dir: %s, %d\\n\", fmtname(buf), strcmp(fmtname(buf), \".\")); if(strcmp(fmtname(buf), \".\") != 0 \u0026\u0026 strcmp(fmtname(buf), \"..\") != 0) { find(buf, target); } } } break; } close(fd); } int main(int argc, char *argv[]) { if(argc != 3){ fprintf(2, \"Usage: find files...\\n\"); exit(1); } find(argv[1], argv[2]); exit(0); } 验证 $ ./grade-lab-util find make: 'kernel/kernel' is up to date. == Test find, in current directory == find, in current directory: OK (1.0s) == Test find, recursive == find, recursive: OK (1.2s) ","wordCount":"1119","inLanguage":"zh","datePublished":"2022-11-26T14:30:58+08:00","dateModified":"2022-11-26T14:30:58+08:00","author":{"@type":"Person","name":"LZY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://flyingsnow31.github.io/posts/oslab/lab1-utilities/"},"publisher":{"@type":"Organization","name":"Flying Snow Blog","logo":{"@type":"ImageObject","url":"https://flyingsnow31.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://flyingsnow31.github.io/ accesskey=h title="Flying Snow Blog (Alt + H)">Flying Snow Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://flyingsnow31.github.io/ title=首页><span>首页</span></a></li><li><a href=https://flyingsnow31.github.io/posts/ title=归档><span>归档</span></a></li><li><a href=https://flyingsnow31.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://flyingsnow31.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://flyingsnow31.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Lab1 Utilities</h1><div class=post-description>6.S081 Lab1</div><div class=post-meta><span title='2022-11-26 14:30:58 +0800 +0800'>十一月 26, 2022</span>&nbsp;·&nbsp;LZY</div></header><div class=post-content><h1 id=lab1-utilities>Lab1 Utilities<a hidden class=anchor aria-hidden=true href=#lab1-utilities>#</a></h1><blockquote><p>本实验用于熟悉xv6和系统调用</p></blockquote><h2 id=boot-xv6-easy>Boot xv6 (easy)<a hidden class=anchor aria-hidden=true href=#boot-xv6-easy>#</a></h2><p>启动xv6系统</p><p>首先下载mit提供的针对此次实验设计的xv6版本，而非整体的xv6</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ git clone git://g.csail.mit.edu/xv6-labs-2020
</span></span><span style=display:flex><span>Cloning into <span style=color:#e6db74>&#39;xv6-labs-2020&#39;</span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>$ cd xv6-labs-2020
</span></span><span style=display:flex><span>$ git checkout util
</span></span><span style=display:flex><span>Branch <span style=color:#e6db74>&#39;util&#39;</span> set up to track remote branch <span style=color:#e6db74>&#39;util&#39;</span> from <span style=color:#e6db74>&#39;origin&#39;</span>.
</span></span><span style=display:flex><span>Switched to a new branch <span style=color:#e6db74>&#39;util&#39;</span>
</span></span></code></pre></div><p>在这一步可以将其远程库切换成自己的。</p><p>使用 <code>make qemu</code> 指令编译并通过qemu启动xv6</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make qemu
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc    -c -o kernel/entry.o kernel/entry.S
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel<span style=color:#f92672>=</span>medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie   -c -o kernel/start.o kernel/start.c
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel<span style=color:#f92672>=</span>medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie   -c -o kernel/console.o kernel/console.c
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>nmeta <span style=color:#ae81ff>46</span> <span style=color:#f92672>(</span>boot, super, log blocks <span style=color:#ae81ff>30</span> inode blocks 13, bitmap blocks 1<span style=color:#f92672>)</span> blocks <span style=color:#ae81ff>954</span> total <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>balloc: first <span style=color:#ae81ff>591</span> blocks have been allocated
</span></span><span style=display:flex><span>balloc: write bitmap block at sector <span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp <span style=color:#ae81ff>3</span> -nographic -drive file<span style=color:#f92672>=</span>fs.img,if<span style=color:#f92672>=</span>none,format<span style=color:#f92672>=</span>raw,id<span style=color:#f92672>=</span>x0 -device virtio-blk-device,drive<span style=color:#f92672>=</span>x0,bus<span style=color:#f92672>=</span>virtio-mmio-bus.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xv6 kernel is booting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hart <span style=color:#ae81ff>2</span> starting
</span></span><span style=display:flex><span>hart <span style=color:#ae81ff>1</span> starting
</span></span><span style=display:flex><span>init: starting sh
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>输入 <code>ls</code> 命令，可以查看当前目录下的所有信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>.              <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>..             <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>README         <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2059</span>
</span></span><span style=display:flex><span>xargstest.sh   <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>93</span>
</span></span><span style=display:flex><span>cat            <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>23968</span>
</span></span><span style=display:flex><span>echo           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>22800</span>
</span></span><span style=display:flex><span>forktest       <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>13168</span>
</span></span><span style=display:flex><span>grep           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>27320</span>
</span></span><span style=display:flex><span>init           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>23896</span>
</span></span><span style=display:flex><span>kill           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>22768</span>
</span></span><span style=display:flex><span>ln             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>22720</span>
</span></span><span style=display:flex><span>ls             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>26208</span>
</span></span><span style=display:flex><span>mkdir          <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>12</span> <span style=color:#ae81ff>22872</span>
</span></span><span style=display:flex><span>rm             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>22856</span>
</span></span><span style=display:flex><span>sh             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>41752</span>
</span></span><span style=display:flex><span>stressfs       <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>23872</span>
</span></span><span style=display:flex><span>usertests      <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>147512</span>
</span></span><span style=display:flex><span>grind          <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>37984</span>
</span></span><span style=display:flex><span>wc             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>18</span> <span style=color:#ae81ff>25104</span>
</span></span><span style=display:flex><span>zombie         <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>19</span> <span style=color:#ae81ff>22272</span>
</span></span><span style=display:flex><span>console        <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>通过执行 <code>Ctrl</code> + <code>p</code> 可以实现类似 <code>ps</code> 的操作，查看现在执行的所有进程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> sleep  init
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> sleep  sh
</span></span></code></pre></div><p>要退出qemu，执行 <code>Ctrl</code> - <code>a</code> <code>x</code></p><p><strong>注意</strong> 先按 <code>Ctrl</code> - <code>a</code> 松开后按 <code>x</code></p><h2 id=sleep-easy>sleep (easy)<a hidden class=anchor aria-hidden=true href=#sleep-easy>#</a></h2><p>实现xv6的Unix程序睡眠；您的睡眠应该暂停一个用户指定的节拍数。计时是由xv6内核定义的时间概念，即来自计时器芯片的两个中断之间的时间。您的解决方案应该在文件USER/sleep.c中。</p><ul><li><p>首先应该阅读 <a href=https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf>https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf</a> xv6 book的第一章节</p></li><li><p>将文件实现放在 <code>user/</code> 目录下，可以参考其中的 echo.c, grep.c, rm.c 等</p></li><li><p>处理命令行参数个数问题</p></li><li><p>使用 <code>atoi()</code> 转换字符串到整型</p></li><li><p>使用系统调用sleep</p></li><li><p>查看 <code>kernel/sysproc.c</code> 中，xv6内核关于sleep系统调用的实现，以及 <code>user/usys.S</code> 关于汇编代码中跳转的部分</p></li><li><p>确保main函数执行完成后调用 exit()退出程序</p></li><li><p>将sleep加入到Makefile中的UPROGS变量中，以便在 <code>make qemu</code> 时，对其进行编译并能在xv6的shell中调用</p></li></ul><p>实现如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/stat.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;user/user.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(argc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;Usage: sleep time...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> n;
</span></span><span style=display:flex><span>    n <span style=color:#f92672>=</span> <span style=color:#a6e22e>atoi</span>(argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sleep</span>(n);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在makefile中添加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>UPROGS<span style=color:#f92672>=</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_cat<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_echo<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_forktest<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_grep<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_init<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_kill<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_ln<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_ls<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_mkdir<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_rm<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_sh<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_stressfs<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_usertests<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_grind<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_wc<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_zombie<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	$U/_sleep<span style=color:#ae81ff>\
</span></span></span></code></pre></div><p>编译测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make qemu
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -DSOL_UTIL -MD -mcmodel<span style=color:#f92672>=</span>medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie   -c -o user/sleep.o user/sleep.c
</span></span><span style=display:flex><span>riscv64-unknown-elf-ld -z max-page-size<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span> -N -e main -Ttext <span style=color:#ae81ff>0</span> -o user/_sleep user/sleep.o user/ulib.o user/usys.o user/printf.o user/umalloc.o
</span></span><span style=display:flex><span>riscv64-unknown-elf-objdump -S user/_sleep &gt; user/sleep.asm
</span></span><span style=display:flex><span>riscv64-unknown-elf-objdump -t user/_sleep | sed <span style=color:#e6db74>&#39;1,/SYMBOL TABLE/d; s/ .* / /; /^$/d&#39;</span> &gt; user/sleep.sym
</span></span><span style=display:flex><span>mkfs/mkfs fs.img README  user/xargstest.sh user/_cat user/_echo user/_forktest user/_grep user/_init user/_kill user/_ln user/_ls user/_mkdir user/_rm user/_sh user/_stressfs user/_usertests user/_grind user/_wc user/_zombie user/_sleep
</span></span><span style=display:flex><span>nmeta <span style=color:#ae81ff>46</span> <span style=color:#f92672>(</span>boot, super, log blocks <span style=color:#ae81ff>30</span> inode blocks 13, bitmap blocks 1<span style=color:#f92672>)</span> blocks <span style=color:#ae81ff>954</span> total <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>balloc: first <span style=color:#ae81ff>615</span> blocks have been allocated
</span></span><span style=display:flex><span>balloc: write bitmap block at sector <span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp <span style=color:#ae81ff>3</span> -nographic -drive file<span style=color:#f92672>=</span>fs.img,if<span style=color:#f92672>=</span>none,format<span style=color:#f92672>=</span>raw,id<span style=color:#f92672>=</span>x0 -device virtio-blk-device,drive<span style=color:#f92672>=</span>x0,bus<span style=color:#f92672>=</span>virtio-mmio-bus.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xv6 kernel is booting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hart <span style=color:#ae81ff>1</span> starting
</span></span><span style=display:flex><span>hart <span style=color:#ae81ff>2</span> starting
</span></span><span style=display:flex><span>init: starting sh
</span></span><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>.              <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>..             <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>README         <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2059</span>
</span></span><span style=display:flex><span>xargstest.sh   <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>93</span>
</span></span><span style=display:flex><span>cat            <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>23968</span>
</span></span><span style=display:flex><span>echo           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>22800</span>
</span></span><span style=display:flex><span>forktest       <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>13168</span>
</span></span><span style=display:flex><span>grep           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>27320</span>
</span></span><span style=display:flex><span>init           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>23896</span>
</span></span><span style=display:flex><span>kill           <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>22768</span>
</span></span><span style=display:flex><span>ln             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>22720</span>
</span></span><span style=display:flex><span>ls             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>26208</span>
</span></span><span style=display:flex><span>mkdir          <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>12</span> <span style=color:#ae81ff>22872</span>
</span></span><span style=display:flex><span>rm             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>22856</span>
</span></span><span style=display:flex><span>sh             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>41752</span>
</span></span><span style=display:flex><span>stressfs       <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>23872</span>
</span></span><span style=display:flex><span>usertests      <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>147512</span>
</span></span><span style=display:flex><span>grind          <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>37984</span>
</span></span><span style=display:flex><span>wc             <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>18</span> <span style=color:#ae81ff>25104</span>
</span></span><span style=display:flex><span>zombie         <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>19</span> <span style=color:#ae81ff>22272</span>
</span></span><span style=display:flex><span>sleep          <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>22744</span>
</span></span><span style=display:flex><span>console        <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>21</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>$ sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>执行成功</p><h3 id=验证>验证<a hidden class=anchor aria-hidden=true href=#验证>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./grade-lab-util sleep
</span></span><span style=display:flex><span>make: <span style=color:#e6db74>&#39;kernel/kernel&#39;</span> is up to date.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test sleep, no arguments <span style=color:#f92672>==</span> sleep, no arguments: OK <span style=color:#f92672>(</span>1.0s<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test sleep, returns <span style=color:#f92672>==</span> sleep, returns: OK <span style=color:#f92672>(</span>1.1s<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test sleep, makes syscall <span style=color:#f92672>==</span> sleep, makes syscall: OK <span style=color:#f92672>(</span>1.0s<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=pingpong-easy>pingpong (easy)<a hidden class=anchor aria-hidden=true href=#pingpong-easy>#</a></h2><p>实现一个程序，fork一个子进程，在父进程和子进程之间，使用pipe管道进行信息的传递与发送，最后按照格式输出相应的内容和进程号。</p><p>需要查看xv6 book 1.2和1.3章节的相关内容</p><p>具体实现如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/stat.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;user/user.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p1[<span style=color:#ae81ff>2</span>], p2[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pipe</span>(p1);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pipe</span>(p2);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>20</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> fd1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>dup</span>(p1[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>read</span>(fd1, buf, <span style=color:#66d9ef>sizeof</span>(buf));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strcmp</span>(<span style=color:#e6db74>&#34;ping&#34;</span>, buf) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d:received ping</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>getpid</span>());
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>write</span>(p2[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;pong</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p1[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p1[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p2[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p2[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>write</span>(p1[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;ping</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>20</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> fd2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>dup</span>(p2[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>read</span>(fd2, buf, <span style=color:#66d9ef>sizeof</span>(buf));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strcmp</span>(<span style=color:#e6db74>&#34;pong&#34;</span>, buf) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d:received pong</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>getpid</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p1[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p1[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p2[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p2[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>将其加入到makefile后，编译执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ pingpong
</span></span><span style=display:flex><span>4:received ping
</span></span><span style=display:flex><span>3:received pong
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>执行成功</p><h3 id=验证-1>验证<a hidden class=anchor aria-hidden=true href=#验证-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./grade-lab-util pingpong
</span></span><span style=display:flex><span>make: <span style=color:#e6db74>&#39;kernel/kernel&#39;</span> is up to date.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test pingpong <span style=color:#f92672>==</span> pingpong: OK <span style=color:#f92672>(</span>0.6s<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=prime-moderatehard>prime (moderate)/(hard)<a hidden class=anchor aria-hidden=true href=#prime-moderatehard>#</a></h2><p>实现一个程序，多个进程相连，形成一个流水线，第一个进程向管道中从2输入到35，后续进程依次打印出其中的素数。</p><p>需要熟悉对于管道和文件描述符的操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/stat.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;user/user.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prime</span>(<span style=color:#66d9ef>int</span> p[<span style=color:#ae81ff>2</span>]) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(p[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p2[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pipe</span>(p2);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> first[<span style=color:#ae81ff>1</span>],second[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>read</span>(p[<span style=color:#ae81ff>0</span>], first, <span style=color:#ae81ff>4</span>)){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;prime %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, first[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>prime</span>(p2);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span>(<span style=color:#a6e22e>read</span>(p[<span style=color:#ae81ff>0</span>], second, <span style=color:#ae81ff>4</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(second[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>%</span> first[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>write</span>(p2[<span style=color:#ae81ff>1</span>], second, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p2[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> p1[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pipe</span>(p1);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> left[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>prime</span>(p1);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>35</span>; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>            <span style=color:#f92672>*</span>left <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>write</span>(p1[<span style=color:#ae81ff>1</span>], left, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(p1[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=验证-2>验证<a hidden class=anchor aria-hidden=true href=#验证-2>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./grade-lab-util prime
</span></span><span style=display:flex><span>make: <span style=color:#e6db74>&#39;kernel/kernel&#39;</span> is up to date.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test primes <span style=color:#f92672>==</span> primes: OK <span style=color:#f92672>(</span>0.6s<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=find-moderate>find (moderate)<a hidden class=anchor aria-hidden=true href=#find-moderate>#</a></h2><blockquote><p>实现一个查找程序，查找目录下的指定文件</p></blockquote><p>根据提示，模仿ls.c的程序代码实现，可以发现，可以使用其中的格式化文件命以及遍历目录文件的方式。</p><p>值得注意的是，其中的格式化文件名中，会将较短的文件名扩充至一个dirsiz的大小，如果使用此函数与目标文件名进行比较会出错，需要修改。</p><p>此外，要注意递归的文件，防止递查询 <code>.</code> 和 <code>..</code> 目录。</p><p>实现代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/stat.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;user/user.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;kernel/fs.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmtname</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> buf[DIRSIZ<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>p;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Find first character after last slash.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span>(p<span style=color:#f92672>=</span>path<span style=color:#f92672>+</span><span style=color:#a6e22e>strlen</span>(path); p <span style=color:#f92672>&gt;=</span> path <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>p <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;/&#39;</span>; p<span style=color:#f92672>--</span>)
</span></span><span style=display:flex><span>    ;
</span></span><span style=display:flex><span>  p<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Return blank-padded name.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strlen</span>(p) <span style=color:#f92672>&gt;=</span> DIRSIZ)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> p;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>memmove</span>(buf, p, <span style=color:#a6e22e>strlen</span>(p));
</span></span><span style=display:flex><span>  buf[<span style=color:#a6e22e>strlen</span>(p)] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>//memset(buf+strlen(p), &#39; &#39;, DIRSIZ-strlen(p));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> buf;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>find</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>target) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>], <span style=color:#f92672>*</span>p;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> fd;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> dirent de;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> stat st;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>((fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(path, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fprintf</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;ls: cannot open %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, path);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fstat</span>(fd, <span style=color:#f92672>&amp;</span>st) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fprintf</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;ls: cannot stat %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, path);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//printf(&#34;%s\n&#34;, path);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>switch</span>(st.type){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> T_FILE:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strcmp</span>(<span style=color:#a6e22e>fmtname</span>(path), target) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, path);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> T_DIR:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strlen</span>(path) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> DIRSIZ <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>sizeof</span> buf){
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;ls: path too long</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strcpy</span>(buf, path);
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> buf<span style=color:#f92672>+</span><span style=color:#a6e22e>strlen</span>(buf);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>p<span style=color:#f92672>++</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#a6e22e>read</span>(fd, <span style=color:#f92672>&amp;</span>de, <span style=color:#66d9ef>sizeof</span>(de)) <span style=color:#f92672>==</span> <span style=color:#66d9ef>sizeof</span>(de)){
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(de.inum <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>memmove</span>(p, de.name, DIRSIZ);
</span></span><span style=display:flex><span>      p[DIRSIZ] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#75715e>//printf(&#34;read: %s\n&#34;, fmtname(buf));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>stat</span>(buf, <span style=color:#f92672>&amp;</span>st) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;ls: cannot stat %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buf);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(st.type <span style=color:#f92672>==</span> T_FILE <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>strcmp</span>(<span style=color:#a6e22e>fmtname</span>(buf), target) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buf);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(st.type <span style=color:#f92672>==</span> T_DIR) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//printf(&#34;t:dir: %s, %d\n&#34;, fmtname(buf), strcmp(fmtname(buf), &#34;.&#34;));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strcmp</span>(<span style=color:#a6e22e>fmtname</span>(buf), <span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>strcmp</span>(<span style=color:#a6e22e>fmtname</span>(buf), <span style=color:#e6db74>&#34;..&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>find</span>(buf, target);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(argc <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fprintf</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;Usage: find files...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>find</span>(argv[<span style=color:#ae81ff>1</span>], argv[<span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=验证-3>验证<a hidden class=anchor aria-hidden=true href=#验证-3>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./grade-lab-util find
</span></span><span style=display:flex><span>make: <span style=color:#e6db74>&#39;kernel/kernel&#39;</span> is up to date.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test find, in current directory <span style=color:#f92672>==</span> find, in current directory: OK <span style=color:#f92672>(</span>1.0s<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> Test find, recursive <span style=color:#f92672>==</span> find, recursive: OK <span style=color:#f92672>(</span>1.2s<span style=color:#f92672>)</span> 
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://flyingsnow31.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a></li><li><a href=https://flyingsnow31.github.io/tags/6.s081/>6.S081</a></li><li><a href=https://flyingsnow31.github.io/tags/utilities/>Utilities</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://flyingsnow31.github.io/>Flying Snow Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>